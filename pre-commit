#!/bin/sh
#
# Git pre-commit hook
# ã‚³ãƒŸãƒƒãƒˆå‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸJS/SCSSãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦
# prettierã¨eslintã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•æ•´å½¢ãƒ»ä¿®æ­£ã—ã¾ã™
# ï¼ˆDockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œï¼‰
#

# ============================================================================
# åˆæœŸè¨­å®š
# ============================================================================

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR" || exit 1

# docker-compose.ymlãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç‰¹å®š
# dev-front/é…ä¸‹ã«ã‚ã‚‹å ´åˆã¨ã€ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹å ´åˆã®ä¸¡æ–¹ã«å¯¾å¿œ
if [ -f "dev-front/docker-compose.yml" ]; then
  COMPOSE_DIR="$ROOT_DIR/dev-front"
elif [ -f "docker-compose.yml" ]; then
  COMPOSE_DIR="$ROOT_DIR"
else
  echo "âŒ docker-compose.ymlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  exit 1
fi

# ============================================================================
# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
# ============================================================================

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
if [ -f "$COMPOSE_DIR/.env" ]; then
  set -a
  . "$COMPOSE_DIR/.env"
  set +a
fi

# Docker Composeã‚µãƒ¼ãƒ“ã‚¹åï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€æœªè¨­å®šæ™‚ã¯frontendã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
SERVICE="${SERVICE:-frontend}"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€æœªè¨­å®šæ™‚ã¯sample_hpã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
PROJECT_NAME="${PROJECT_NAME:-sample_hp}"

# ã‚³ãƒ³ãƒ†ãƒŠåã‚’æ§‹ç¯‰ï¼ˆå½¢å¼: ${PROJECT_NAME}_${SERVICE}ï¼‰
CONTAINER_NAME="${PROJECT_NAME}_${SERVICE}"

# ============================================================================
# Dockerã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ç¢ºèª
# ============================================================================

cd "$COMPOSE_DIR" || exit 1

# ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
if ! docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_NAME}$"; then
  echo "âš ï¸  Dockerã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚èµ·å‹•ä¸­..."
  docker compose up -d "${SERVICE}" || exit 1
  sleep 2
fi

cd "$ROOT_DIR" || exit 1

# ============================================================================
# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã¨åˆ†é¡
# ============================================================================

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´ãƒ»ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯çµ‚äº†
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# JSãƒ•ã‚¡ã‚¤ãƒ«ã¨SCSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é¡
JS_FILES=""
SCSS_FILES=""

for file in $STAGED_FILES; do
  # dev-front/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
  case "$file" in
    dev-front/*)
      relative_file="${file#dev-front/}"
      ;;
    *)
      relative_file="$file"
      ;;
  esac
  
  # JSãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆresources/htdocs/src/js/é…ä¸‹ï¼‰ã‚’æŠ½å‡º
  if echo "$relative_file" | grep -q "^resources/htdocs/src/js/.*\.js$"; then
    JS_FILES="$JS_FILES $file"
  fi
  
  # SCSSãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆresources/htdocs/src/scss/é…ä¸‹ï¼‰ã‚’æŠ½å‡º
  if echo "$relative_file" | grep -q "^resources/htdocs/src/scss/.*\.scss$"; then
    SCSS_FILES="$SCSS_FILES $file"
  fi
done

# ============================================================================
# SCSSãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´å½¢å‡¦ç†
# ============================================================================

if [ -n "$SCSS_FILES" ]; then
  echo "ğŸ”§ SCSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ä¸­..."
  for file in $SCSS_FILES; do
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›ï¼ˆdev-front/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼‰
    case "$file" in
      dev-front/*)
        relative_file="${file#dev-front/resources/}"
        ;;
      *)
        relative_file="${file#resources/}"
        ;;
    esac
    
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§prettierã‚’å®Ÿè¡Œã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢
    docker exec "${CONTAINER_NAME}" npx prettier --write "/var/www/resources/${relative_file}" || exit 1
    
    # æ•´å½¢å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã«è¿½åŠ 
    git add "$file"
  done
fi

# ============================================================================
# JSãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´å½¢ãƒ»ä¿®æ­£å‡¦ç†
# ============================================================================

if [ -n "$JS_FILES" ]; then
  # prettierã§JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢
  echo "ğŸ”§ JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ä¸­..."
  for file in $JS_FILES; do
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›ï¼ˆdev-front/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼‰
    case "$file" in
      dev-front/*)
        relative_file="${file#dev-front/resources/}"
        ;;
      *)
        relative_file="${file#resources/}"
        ;;
    esac
    
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§prettierã‚’å®Ÿè¡Œã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢
    docker exec "${CONTAINER_NAME}" npx prettier --write "/var/www/resources/${relative_file}" || exit 1
    
    # æ•´å½¢å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã«è¿½åŠ 
    git add "$file"
  done
  
  # eslintã§JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
  echo "ğŸ”§ JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ESLintã§ä¿®æ­£ä¸­..."
  for file in $JS_FILES; do
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›ï¼ˆdev-front/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼‰
    case "$file" in
      dev-front/*)
        relative_file="${file#dev-front/resources/}"
        ;;
      *)
        relative_file="${file#resources/}"
        ;;
    esac
    
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§eslint --fixã‚’å®Ÿè¡Œã—ã¦è‡ªå‹•ä¿®æ­£
    docker exec "${CONTAINER_NAME}" npx eslint --fix "/var/www/resources/${relative_file}" || exit 1
    
    # ä¿®æ­£å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã«è¿½åŠ 
    git add "$file"
  done
fi

exit 0