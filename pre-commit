#!/bin/sh
# ã‚³ãƒŸãƒƒãƒˆå‰ã«prettierã¨eslintã®fixã‚’å®Ÿè¡Œï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œï¼‰

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’å–å¾—
ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR" || exit 1

# docker-compose.ymlãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç‰¹å®š
# dev-front/é…ä¸‹ã«ã‚ã‚‹å ´åˆã¨ã€ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹å ´åˆã®ä¸¡æ–¹ã«å¯¾å¿œ
if [ -f "dev-front/docker-compose.yml" ]; then
  COMPOSE_DIR="$ROOT_DIR/dev-front"
elif [ -f "docker-compose.yml" ]; then
  COMPOSE_DIR="$ROOT_DIR"
else
  echo "âŒ docker-compose.ymlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  exit 1
fi

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
if [ -f "$COMPOSE_DIR/.env" ]; then
  # .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¨ç©ºè¡Œã‚’é™¤å¤–ï¼‰
  set -a
  . "$COMPOSE_DIR/.env"
  set +a
fi

# Docker Composeã‚µãƒ¼ãƒ“ã‚¹åï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€æœªè¨­å®šã®å ´åˆã¯frontendã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
SERVICE="${SERVICE:-frontend}"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€æœªè¨­å®šã®å ´åˆã¯sample_hpã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
PROJECT_NAME="${PROJECT_NAME:-sample_hp}"

# ã‚³ãƒ³ãƒ†ãƒŠåï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ§‹ç¯‰ï¼‰
CONTAINER_NAME="${PROJECT_NAME}_${SERVICE}"

# docker-compose.ymlãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
cd "$COMPOSE_DIR" || exit 1

# ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
if ! docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_NAME}$"; then
  echo "âš ï¸  Dockerã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚èµ·å‹•ä¸­..."
  docker compose up -d "${SERVICE}" || exit 1
  sleep 2
fi

# å…ƒã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
cd "$ROOT_DIR" || exit 1

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

echo "ğŸ” Debug: Staged files: $STAGED_FILES"

if [ -z "$STAGED_FILES" ]; then
  echo "ğŸ” Debug: No staged files"
  exit 0
fi

# JSãƒ•ã‚¡ã‚¤ãƒ«ã¨SCSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
JS_FILES=""
SCSS_FILES=""

for file in $STAGED_FILES; do
  echo "ğŸ” Debug: Checking file: $file"
  
  # dev-front/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
  case "$file" in
    dev-front/*)
      relative_file="${file#dev-front/}"
      ;;
    *)
      relative_file="$file"
      ;;
  esac
  
  # JSãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆresources/htdocs/src/js/é…ä¸‹ï¼‰
  if echo "$relative_file" | grep -q "^resources/htdocs/src/js/.*\.js$"; then
    JS_FILES="$JS_FILES $file"
    echo "ğŸ” Debug: Added JS file: $file"
  fi
  
  # SCSSãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆresources/htdocs/src/scss/é…ä¸‹ï¼‰
  if echo "$relative_file" | grep -q "^resources/htdocs/src/scss/.*\.scss$"; then
    SCSS_FILES="$SCSS_FILES $file"
    echo "ğŸ” Debug: Added SCSS file: $file"
  fi
done

# prettierã§SCSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œï¼‰
if [ -n "$SCSS_FILES" ]; then
  echo "ğŸ”§ Running prettier on SCSS files (in container)..."
  for file in $SCSS_FILES; do
    # ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›ï¼‰
    case "$file" in
      dev-front/*)
        relative_file="${file#dev-front/resources/}"
        ;;
      *)
        relative_file="${file#resources/}"
        ;;
    esac
    echo "ğŸ” Debug: Formatting: $relative_file"
    # ã‚³ãƒ³ãƒ†ãƒŠåã‚’ç›´æ¥æŒ‡å®šã—ã¦å®Ÿè¡Œ
    docker exec "${CONTAINER_NAME}" npx prettier --write "/var/www/resources/${relative_file}" || exit 1
    # å…ƒã®ãƒ‘ã‚¹ã§git add
    git add "$file"
  done
else
  echo "ğŸ” Debug: No SCSS files to format"
fi

# prettierã¨eslintã§JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ãƒ»ä¿®æ­£ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œï¼‰
if [ -n "$JS_FILES" ]; then
  echo "ğŸ”§ Running prettier on JS files (in container)..."
  for file in $JS_FILES; do
    # ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›ï¼‰
    case "$file" in
      dev-front/*)
        relative_file="${file#dev-front/resources/}"
        ;;
      *)
        relative_file="${file#resources/}"
        ;;
    esac
    # ã‚³ãƒ³ãƒ†ãƒŠåã‚’ç›´æ¥æŒ‡å®šã—ã¦å®Ÿè¡Œ
    docker exec "${CONTAINER_NAME}" npx prettier --write "/var/www/resources/${relative_file}" || exit 1
    git add "$file"
  done
  
  echo "ğŸ”§ Running eslint --fix on JS files (in container)..."
  for file in $JS_FILES; do
    # ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›ï¼‰
    case "$file" in
      dev-front/*)
        relative_file="${file#dev-front/resources/}"
        ;;
      *)
        relative_file="${file#resources/}"
        ;;
    esac
    # ã‚³ãƒ³ãƒ†ãƒŠåã‚’ç›´æ¥æŒ‡å®šã—ã¦å®Ÿè¡Œ
    docker exec "${CONTAINER_NAME}" npx eslint --fix "/var/www/resources/${relative_file}" || exit 1
    git add "$file"
  done
else
  echo "ğŸ” Debug: No JS files to format"
fi

exit 0