@use 'sass:meta';
@use 'sass:map';
@use '../functions/strip-unit' as *;
@use '../variables/variables' as *;

/******************************************************************
* メディアクエリ
* $media_query_strategy で 'sp-first' または 'pc-first' を切り替え可能
*******************************************************************/
/* 連番ベースの汎用メディアクエリ
* $key: ブレイクポイントのキー（文字列のみ）
* $max-key: オプション。範囲指定の場合の最大キー
* variablesで設定した順序に応じて適用
*
* sp-first: 1が最小、数が大きくなるほど画面サイズが大きい
*   media('tab') => 560px以上
*   media('tab', 'pc') => 560px以上、1120px未満（範囲指定）
*   media('pc') => 1120px以上
*
* pc-first: 1が最大、数が大きくなるほど画面サイズが小さい
*   media('pcLL') => 1920px未満
*   media('pcLL', 'pc') => 1120px以上、1920px未満（範囲指定、大きい方を先に書く）
*   media('pc') => 1120px未満
*   注意: 範囲指定の場合、引数の順序は任意（実際の値の大小関係で自動判定）
*
* 使用例:
*   @include media('tab') { ... }        // tab以上（sp-first）または未満（pc-first）
*   @include media('pc') { ... }         // pc以上（sp-first）または未満（pc-first）
*   @include media('tab', 'pc') { ... }  // tab以上、pc未満（範囲指定）
*   @include media('pc', 'pcL') { ... }  // pc以上、pcL未満（範囲指定）
*
* variablesで定義した文字列キーに自動的に依存します
----------------------------------------------------------------- */
@mixin media($_key, $_max-key: null) {
  // 型チェック（文字列のみ）
  @if meta.type-of($_key) != string {
    @error "breakpoint key must be a string, got #{meta.type-of($_key)}";
  }
  @if $_max-key != null and meta.type-of($_max-key) != string {
    @error "breakpoint max-key must be a string, got #{meta.type-of($_max-key)}";
  }

  // キーがマップに存在するかチェック
  @if not map.has-key($breakpoints, $_key) {
    @error "breakpoint key '#{$_key}' not found in $breakpoints map. Available keys: #{map.keys($breakpoints)}";
  }
  @if $_max-key != null and not map.has-key($breakpoints, $_max-key) {
    @error "breakpoint max-key '#{$_max-key}' not found in $breakpoints map. Available keys: #{map.keys($breakpoints)}";
  }

  // ブレイクポイント値を取得（variablesで設定された順序に従う）
  $_break-value: get-breakpoint($_key);

  // 範囲指定の場合
  @if $_max-key != null {
    $_max-break-value: get-breakpoint($_max-key);

    // 範囲指定は常に「以上」と「未満」で指定（sp-first/pc-firstに関係なく同じ物理的な範囲）
    // ただし、sp-firstとpc-firstで変数の順序が逆なので、実際の値の大小関係を確認
    $_min-value: null;
    $_max-value: null;
    @if strip-unit($_break-value, 1px) < strip-unit($_max-break-value, 1px) {
      $_min-value: $_break-value;
      $_max-value: $_max-break-value;
    } @else {
      $_min-value: $_max-break-value;
      $_max-value: $_break-value;
    }

    @media screen and (strip-unit($_min-value, 1px) <= width < strip-unit($_max-value, 1px)) {
      @content;
    }
  } @else {
    // 単一指定の場合
    @if $media_query_strategy == 'sp-first' {
      // SPファースト: breakpoint-{key}以上
      @media screen and (strip-unit($_break-value, 1px) <= width) {
        @content;
      }
    } @else {
      // PCファースト: breakpoint-{key}未満
      @media screen and (width < strip-unit($_break-value, 1px)) {
        @content;
      }
    }
  }
}

/* 高さメディアクエリ
$break ～$break(含まない)の高さに適用
----------------------------------------------------------------- */
@mixin height-media-max($_break) {
  @media screen and ($_break <= height) {
    @content;
  }
}

/* 高さメディアクエリ
$break $break～の高さに適用
----------------------------------------------------------------- */
@mixin height-media-min($_break) {
  @media screen and ($_break > height) {
    @content;
  }
}

/* 印刷時
----------------------------------------------------------------- */
@mixin print {
  @media print {
    @content;
  }
}
