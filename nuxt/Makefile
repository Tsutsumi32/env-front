.PHONY: help init build up down restart logs shell install dev generate preview clean lint format

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
-include .env
export

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ.env ã«æœªå®šç¾©ã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰
WORK_DIR ?= app
PROJECT_NAME ?= nuxt-portfolio
HOST_PORT ?= 3000
CONTAINER_PORT ?= 3000
PREVIEW_HOST_PORT ?= 3001
PREVIEW_CONTAINER_PORT ?= 3000

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make init       - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆdocker compose up -d & pre-commitãƒ•ãƒƒã‚¯è¨­ç½®ï¼‰"
	@echo "  make build      - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make up         - ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•"
	@echo "  make down       - ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤"
	@echo "  make restart    - ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•"
	@echo "  make logs       - ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make shell      - ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚·ã‚§ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹"
	@echo "  make install    - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make dev        - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹• (http://localhost:$(HOST_PORT))"
	@echo "  make generate   - é™çš„ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆï¼ˆSSGï¼‰"
	@echo "  make preview    - ç”Ÿæˆã•ã‚ŒãŸé™çš„ã‚µã‚¤ãƒˆã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (http://localhost:$(PREVIEW_HOST_PORT))"
	@echo "  make lint       - ESLintã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯"
	@echo "  make format     - Prettierã§ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢"
	@echo "  make clean      - ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã¨node_modulesã‚’å‰Šé™¤"

# åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆdocker compose up -d & pre-commitãƒ•ãƒƒã‚¯è¨­ç½®ï¼‰
# init: ## åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆdocker compose up -d ï¼† pre-commitãƒ•ãƒƒã‚¯è¨­ç½®ï¼‰
# 	@if [ ! -f .env ]; then \
# 		echo "ğŸŸ¡ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚.env-exampleã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã™..."; \
# 		cp -n .env-example .env 2>/dev/null || true; \
# 		echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„ã€‚"; \
# 	fi
# 	@echo "ğŸŸ¢ docker compose up -d ã‚’å®Ÿè¡Œã—ã¾ã™..."
# 	docker compose up -d
# 	@echo "ğŸŸ¢ pre-commit ãƒ•ãƒƒã‚¯ã‚’ .git/hooks ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™..."
# 	@if [ ! -d .git/hooks ]; then \
# 		echo "âŒ .git/hooks ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚git ç®¡ç†ä¸‹ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
# 		exit 1; \
# 	fi
# 	@cp -f pre-commit .git/hooks/pre-commit
# 	@chmod +x .git/hooks/pre-commit
# 	@echo "âœ… åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†: pre-commit ãƒ•ãƒƒã‚¯è¨­ç½®æ¸ˆã¿"

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
build:
	docker compose build

# ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
up:
	docker compose up -d

# ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã€€ãƒ“ãƒ«ãƒ‰ã—ãªãŠã—
up--build:
	docker compose up -d --build

# ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
down:
	docker compose down

# ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•
restart: down up

# ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º
logs:
	docker compose logs -f

# ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚·ã‚§ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆ.env ã® PROJECT_NAME ã§ã‚³ãƒ³ãƒ†ãƒŠåæŒ‡å®šï¼‰
shell:
	docker exec -it $(PROJECT_NAME) bash

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ä¸­ãªã‚‰ã‚³ãƒ³ãƒ†ãƒŠåã§å®Ÿè¡Œã€‚docker exec ã§ã¯ nodenv ã‚’æ˜ç¤ºçš„ã«èª­ã¿è¾¼ã‚€ï¼‰
install:
	docker exec $(PROJECT_NAME) bash -c 'eval "$$(nodenv init -)" && npm install'

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
dev:
	@echo "ğŸŸ¢ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@echo "ğŸ“ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: http://localhost:$(HOST_PORT)"
	docker compose up

# é™çš„ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆï¼ˆSSGï¼‰ï¼ˆWORK_DIR ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè¡Œã€‚ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ä¸­ã§ã‚ã‚‹ã“ã¨ï¼‰
generate:
	@echo "ğŸŸ¡ é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆå‰ã«å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã™..."
	@docker stop $(PROJECT_NAME) 2>/dev/null || true
	@echo "ğŸŸ¢ ãƒ›ã‚¹ãƒˆå´ã®$(WORK_DIR)/.outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã™..."
	@rm -rf $(WORK_DIR)/.output || true
	@echo "ğŸŸ¢ é™çš„ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆä¸­..."
	docker compose run --rm --no-deps nuxt npm run generate
	@echo "âœ… é™çš„ã‚µã‚¤ãƒˆã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ"

# ç”Ÿæˆã•ã‚ŒãŸé™çš„ã‚µã‚¤ãƒˆã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆWORK_DIR ã® .output ã‚’å‚ç…§ï¼‰
preview:
	@if [ ! -d "$(WORK_DIR)/.output" ]; then \
		echo "âŒ $(WORK_DIR)/.output ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"; \
		echo "ğŸŸ¡ é™çš„ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã—ã¾ã™..."; \
		$(MAKE) generate; \
	fi
	@echo "ğŸŸ¢ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@echo "ğŸ“ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: http://localhost:$(HOST_PORT)"
	@echo "ğŸ“ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒ¼ãƒãƒ¼: http://localhost:$(PREVIEW_HOST_PORT)"
	docker compose run --rm -p $(PREVIEW_HOST_PORT):$(PREVIEW_CONTAINER_PORT) nuxt npm run preview

# ESLintã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ³ãƒ†ãƒŠåã§å®Ÿè¡Œï¼‰
lint:
	docker exec $(PROJECT_NAME) bash -c 'eval "$$(nodenv init -)" && npm run lint'

# ESLintã§ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ä¿®æ­£
lint-fix:
	docker exec $(PROJECT_NAME) bash -c 'eval "$$(nodenv init -)" && npm run lint:fix'

# Prettierã§ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢
format:
	docker exec $(PROJECT_NAME) bash -c 'eval "$$(nodenv init -)" && npm run format'

# Prettierã§ã‚³ãƒ¼ãƒ‰ã®æ•´å½¢çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
format-check:
	docker exec $(PROJECT_NAME) bash -c 'eval "$$(nodenv init -)" && npm run format:check'

# ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã¨node_modulesã‚’å‰Šé™¤ï¼ˆWORK_DIR ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé…ä¸‹ã‚’å¯¾è±¡ï¼‰
clean:
	@echo "ğŸŸ¢ ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™..."
	@docker exec $(PROJECT_NAME) bash -c "rm -rf .nuxt .output dist .nitro .data .cache" 2>/dev/null || true
	@echo "ğŸŸ¡ ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¾ã™..."
	@docker stop $(PROJECT_NAME) 2>/dev/null || true
	@echo "ğŸŸ¢ ãƒ›ã‚¹ãƒˆå´ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™..."
	@rm -rf $(WORK_DIR)/node_modules $(WORK_DIR)/.nuxt $(WORK_DIR)/.output $(WORK_DIR)/dist $(WORK_DIR)/.nitro $(WORK_DIR)/.data $(WORK_DIR)/.cache || true
	@echo "ğŸŸ¢ ã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™..."
	docker compose down --rmi all --volumes --remove-orphans
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

